# QCLab 配置文件指南 (CONFIG_GUIDE.md)

## 1. 概述

本文件是 QCLab 测控系统中 `*.json` 配置文件的详细指南。该配置文件是整个实验平台的核心，它以一种结构化的方式存储了从底层硬件到顶层量子逻辑门的所有参数。

正确的理解和修改此文件对于实验的顺利进行至关重要。

### 文件命名约定

通常，配置文件的命名遵循以下约定：

`[芯片编号]_[测试阶段]_[工程师/项目]_[日期].json`

例如：`84V503_ST_LML_250429.json`
- **84V503**: 量子芯片的唯一编号。
- **ST**: 测试阶段，例如 `ST` (Standard Test), `CAL` (Calibration), `DEV` (Development)。
- **LML**: 操作工程师或项目的缩写。
- **250429**: 日期 (年/月/日)。

---

## 2. 顶层结构

配置文件是一个 JSON 对象，包含以下六个主要部分：

1.  **`dev`**: 定义了实验中使用的所有**物理硬件设备**。
2.  **`etc`**: 定义了软件框架的**全局配置和行为**。
3.  **`station`**: 定义了当前实验站的**宏观参数**，如样品信息和默认测量次数。
4.  **`gate`**: **核心部分**。一个庞大的数据库，存储了每个量子比特上所有量子门的精确校准参数。
5.  **`usr`**: 记录了当前用户会话和软件**进程的状态**，主要用于调试。
6.  **`var`**: 一个用于定义可在实验脚本中使用的**全局变量**的区域。

---

## 3. 各部分详解

### 3.1 `dev` (硬件设备)

此部分列出了所有已连接的物理仪器。

```json
"dev": {
    "NS_PQ": {
        "addr": "192.168.110.25",
        "name": "NS_DDS_NEW",
        "type": "driver",
        "srate": 6400000000.0,
        "inuse": true
    },
    "NS_PQ_QSYNC": {
        "addr": "192.168.110.25",
        "name": "NS_QSYNC",
        "type": "driver"
    }
}
```

- **`NS_PQ`**: 仪器的**逻辑名称**，在软件中用于指代该设备。
- **`addr`**: 仪器的物理地址（例如 IP 地址、GPIB 地址）。
- **`name`**: 需要加载的**驱动程序名称**，对应 `home/dev/` 目录下的驱动文件名。
- **`srate`**: 仪器的采样率（单位：Sa/s），对于 AWG 和数字化仪至关重要。
- **`inuse`**: 一个布尔标志，表示该设备当前是否正在被使用。

### 3.2 `etc` (全局配置)

此部分配置了软件框架的通用行为。

```json
"etc": {
    "driver": {
        "path": "systemq.dev",
        "mapping": {
            "waveform_RF_I": "I.Waveform",
            "setting_PNT": "ADC.PointNumber"
        }
    },
    "server": {
        "workers": 4,
        "schedule": { "job": { "hour": "2" } }
    }
}
```

- **`driver.path`**: 驱动程序所在的 Python 模块路径。
- **`driver.mapping`**: **硬件抽象层 (HAL)** 的核心。它将一个通用的、物理无关的指令（如 `waveform_RF_I`）映射到具体仪器驱动的一个属性上（如 `I.Waveform`）。这使得实验代码可以独立于具体硬件。
- **`server.workers`**: 后端服务器用于并行处理任务的工作进程数。
- **`server.schedule`**: 自动化任务调度配置。例如，可以在每天凌晨2点自动运行校准程序。

### 3.3 `station` (实验站)

定义了本次实验的宏观设定。

```json
"station": {
    "sample": "84V503_ST_LML_250429",
    "triggercmds": [ "NS_PQ_QSYNC.CH1.TRIG" ],
    "shots": 1024,
    "default_delay": 1e-06
}
```

- **`sample`**: 当前正在测试的样品名称，应与文件名对应。
- **`triggercmds`**: 触发一次完整实验序列所需的命令。
- **`shots`**: 默认的单次测量重复次数，用于统计平均。
- **`default_delay`**: 两次 `shots` 之间的默认等待时间（单位：秒）。

### 3.4 `gate` (量子门参数)

**这是配置文件中最重要、最庞大的部分**。它是一个数据库，存储了所有量子比特的详细校准参数。

```json
"gate": {
    "Measure": {
        "Q29": {
            "params": {
                "frequency": 7298874408.53,
                "amp": 0.14,
                "duration": 3.072e-06,
                "threshold": 136921.92
            }
        }
    },
    "R": {
        "Q29": {
            "params": {
                "frequency": 4251322765.38,
                "amp": 0.117,
                "width": 5e-08
            }
        }
    }
}
```

- **结构**: 参数以 `gate.<门名称>.<比特名称>.params` 的层级结构组织。
- **`Measure` 门**:
    - `frequency`: **读出谐振腔的中心频率 (Hz)**。通过 S21 实验找到。
    - `amp`, `duration`: 读出脉冲的幅度（V）和时长（s）。
    - `threshold`: 用于区分比特 `|0>` 和 `|1>` 态的 IQ 值阈值。**`0` 值通常意味着该比特尚未校准**。
- **`R` 门 (单比特旋转门)**:
    - `frequency`: **量子比特的跃迁频率 (Hz)**。通过能谱实验找到。
    - `amp`, `width`: 驱动脉冲的幅度（V）和时长（s）。这些参数共同决定了旋转角度（例如，π-pulse, π/2-pulse）。
    - **注意**: 具有默认值（如 4e9 Hz）的参数表明该比特的此项操作**尚未校准**。

### 3.5 `usr` 和 `var`

- **`usr`**: 记录了软件的进程ID（PID），主要供开发者在调试时使用，用户通常无需关心。
- **`var`**: 一个空的对象，用户可以在此定义一些全局变量，并在实验脚本中通过 `s.query('var.my_variable')` 来引用它们。

---

## 4. 如何使用

1.  **加载**: 在实验脚本开始时，系统会自动加载一个默认的或指定的配置文件。
2.  **读取**: 在实验代码中（如 `s21.py`），通过 `s.query('Q1.Measure.frequency')` 来获取初始参数。
3.  **执行**: 运行实验（如 Rabi, S21, Ramsey 等）来获得新的、更精确的参数。
4.  **更新**: 使用 `s.update({'Q1.Measure.frequency': new_freq})` 将校准后的新参数写回服务器。服务器会保存这些更新，并最终可以将其写回到一个新的配置文件中。

这个**读取-执行-更新**的闭环是自动化校准流程的基础。
